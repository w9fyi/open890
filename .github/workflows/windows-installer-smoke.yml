name: Windows Installer Smoke Test

on:
  workflow_dispatch:
    inputs:
      installer_url:
        description: "Direct URL to installer .exe"
        required: true
        default: "https://github.com/w9fyi/open890/releases/download/v0.1.5/open890-v0.1.5-setup.exe"
      app_url:
        description: "URL to probe for readiness"
        required: true
        default: "http://localhost:4000"
      timeout_seconds:
        description: "Seconds to wait for open890 readiness"
        required: true
        default: "90"

permissions:
  contents: read

jobs:
  smoke:
    runs-on: windows-latest
    steps:
      - name: Download installer
        shell: powershell
        run: |
          $ProgressPreference = "SilentlyContinue"
          $installerPath = Join-Path $env:RUNNER_TEMP "open890-setup.exe"
          Invoke-WebRequest -Uri "${{ inputs.installer_url }}" -OutFile $installerPath
          "INSTALLER_PATH=$installerPath" >> $env:GITHUB_ENV

      - name: Run installer silently
        shell: powershell
        run: |
          $installLog = Join-Path $env:RUNNER_TEMP "open890-install.log"
          $args = "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP- /LOG=`"$installLog`""
          $proc = Start-Process -FilePath $env:INSTALLER_PATH -ArgumentList $args -Wait -PassThru

          "INSTALL_LOG=$installLog" >> $env:GITHUB_ENV
          "INSTALL_EXIT_CODE=$($proc.ExitCode)" >> $env:GITHUB_ENV

          if ($proc.ExitCode -ne 0) {
            throw "Installer exited with non-zero code: $($proc.ExitCode)"
          }

      - name: Locate install directory
        shell: powershell
        run: |
          $candidates = @(
            "$env:ProgramFiles\open890",
            "${env:ProgramFiles(x86)}\open890"
          )

          $installRoot = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $installRoot) {
            throw "open890 install directory was not found under Program Files."
          }

          "INSTALL_ROOT=$installRoot" >> $env:GITHUB_ENV

      - name: Verify expected installed files
        shell: powershell
        run: |
          $required = @(
            "$env:INSTALL_ROOT\open890-launcher.bat",
            "$env:INSTALL_ROOT\open890-launcher.ps1",
            "$env:INSTALL_ROOT\bin\open890.bat"
          )
          $unexpected = @(
            "$env:INSTALL_ROOT\open890.command",
            "$env:INSTALL_ROOT\open890-stop.command",
            "$env:INSTALL_ROOT\open890-launcher-macos.sh",
            "$env:INSTALL_ROOT\open890.sh"
          )

          foreach ($path in $required) {
            if (!(Test-Path $path)) {
              throw "Missing required installed file: $path"
            }
          }

          foreach ($path in $unexpected) {
            if (Test-Path $path) {
              throw "Unexpected non-Windows launcher file present: $path"
            }
          }

          $binScript = "$env:INSTALL_ROOT\bin\open890.bat"
          $binScriptContents = Get-Content -Path $binScript -Raw
          if ($binScriptContents -notlike '*cd /d "%~dp0\.."*') {
            throw "Installed launcher script is missing drive switch fix (cd /d): $binScript"
          }

      - name: Start open890 and wait for readiness
        shell: powershell
        run: |
          $appUrl = "${{ inputs.app_url }}"
          $timeoutSeconds = [int]"${{ inputs.timeout_seconds }}"
          $startScript = Join-Path $env:INSTALL_ROOT "bin\open890.bat"
          $traceScript = Join-Path $env:INSTALL_ROOT "bin\open890-trace.bat"
          $serverLog = Join-Path $env:TEMP "open890-server.log"
          $startStdoutLog = Join-Path $env:RUNNER_TEMP "open890-start-stdout.log"
          $startStderrLog = Join-Path $env:RUNNER_TEMP "open890-start-stderr.log"
          $probeLog = Join-Path $env:RUNNER_TEMP "open890-readiness-probe.log"
          $startMetaLog = Join-Path $env:RUNNER_TEMP "open890-start-meta.txt"
          $ready = $false
          $startExitCode = $null

          foreach ($path in @($serverLog, $startStdoutLog, $startStderrLog, $probeLog, $startMetaLog)) {
            if (Test-Path $path) {
              Remove-Item -Path $path -Force -ErrorAction SilentlyContinue
            }
          }

          "OPEN890_SERVER_LOG=$serverLog" >> $env:GITHUB_ENV
          "OPEN890_START_STDOUT_LOG=$startStdoutLog" >> $env:GITHUB_ENV
          "OPEN890_START_STDERR_LOG=$startStderrLog" >> $env:GITHUB_ENV
          "OPEN890_PROBE_LOG=$probeLog" >> $env:GITHUB_ENV
          "OPEN890_START_META_LOG=$startMetaLog" >> $env:GITHUB_ENV

          if (!(Test-Path $startScript)) {
            throw "Start script was not found: $startScript"
          }

          Copy-Item -Path $startScript -Destination $traceScript -Force
          $traceScriptContent = Get-Content -Path $traceScript -Raw
          $traceScriptContent = $traceScriptContent -replace '(?im)^\s*@echo off\s*$', 'echo on'
          Set-Content -Path $traceScript -Value $traceScriptContent -Encoding ascii
          $env:ELIXIR_CLI_ECHO = "1"

          $startProc = Start-Process `
            -FilePath $env:ComSpec `
            -ArgumentList @("/d", "/v:on", "/c", "`"$traceScript`" start") `
            -WindowStyle Hidden `
            -PassThru `
            -RedirectStandardOutput $startStdoutLog `
            -RedirectStandardError $startStderrLog

          @(
            "start_pid=$($startProc.Id)",
            "start_script=$startScript",
            "trace_script=$traceScript",
            "app_url=$appUrl",
            "timeout_seconds=$timeoutSeconds"
          ) | Out-File -FilePath $startMetaLog -Encoding UTF8

          Add-Content -Path $probeLog -Value ("{0}`tstart_spawned_pid={1}" -f (Get-Date -Format o), $startProc.Id)

          for ($i = 0; $i -lt $timeoutSeconds; $i++) {
            $probeResult = "not_ready"
            try {
              $response = Invoke-WebRequest -UseBasicParsing -Uri $appUrl -TimeoutSec 2
              if ($response.StatusCode -ge 200 -and $response.StatusCode -lt 500) {
                $ready = $true
                $probeResult = "ready_status=$($response.StatusCode)"
              }
            } catch {
              $probeResult = "request_error=$($_.Exception.Message)"
            }

            Add-Content -Path $probeLog -Value ("{0}`tattempt={1}`t{2}" -f (Get-Date -Format o), ($i + 1), $probeResult)

            $startProc.Refresh()
            if ($startProc.HasExited) {
              $startProc.WaitForExit()
              $startProc.Refresh()
              try {
                $startExitCode = [int]$startProc.ExitCode
              } catch {
                $startExitCode = $null
              }
              Add-Content -Path $probeLog -Value ("{0}`tstart_process_exited={1}" -f (Get-Date -Format o), ($(if ($startExitCode -ne $null) { $startExitCode } else { "n/a" })))
              if ($startExitCode -ne $null -and $startExitCode -ne 0) {
                break
              }
            }

            if ($ready) {
              break
            }
            Start-Sleep -Seconds 1
          }

          $startProc.Refresh()
          if ($startProc.HasExited -and $startExitCode -eq $null) {
            $startProc.WaitForExit()
            $startProc.Refresh()
            try {
              $startExitCode = [int]$startProc.ExitCode
            } catch {
              $startExitCode = $null
            }
          }

          Add-Content -Path $startMetaLog -Value ("start_process_final_state={0}" -f ($(if ($startProc.HasExited) { "exited" } else { "running" })))
          Add-Content -Path $startMetaLog -Value ("start_process_exit_code={0}" -f ($(if ($startExitCode -ne $null) { $startExitCode } else { "n/a" })))
          Add-Content -Path $startMetaLog -Value ("ready={0}" -f $ready)

          if (-not $ready) {
            if ($startExitCode -ne $null -and $startExitCode -ne 0) {
              throw "open890 start command exited with code $startExitCode before readiness check succeeded."
            }
            throw "open890 did not become ready at $appUrl within $timeoutSeconds seconds."
          }

      - name: Stop open890 (pre-launcher test)
        shell: powershell
        run: |
          $stopScript = "$env:INSTALL_ROOT\bin\open890.bat"
          if (Test-Path $stopScript) {
            Start-Process -FilePath $env:ComSpec -ArgumentList "/c `"$stopScript`" stop" -Wait -WindowStyle Hidden
          }
          # Give the node a moment to fully release the port
          Start-Sleep -Seconds 3

      - name: Start open890 via PS1 launcher (headless)
        shell: powershell
        run: |
          $appUrl = "${{ inputs.app_url }}"
          $timeoutSeconds = [int]"${{ inputs.timeout_seconds }}"
          $launcherScript = "$env:INSTALL_ROOT\open890-launcher.ps1"
          # Use a single argument string with explicit path quoting.
          # Do NOT use -RedirectStandardOutput/-RedirectStandardError with -Wait:
          # doing so forces UseShellExecute=false on the child, which allows the
          # Erlang server (grandchild) to inherit pipe handles and deadlock the wait.
          $launcherArgs = "-NoProfile -ExecutionPolicy Bypass -File `"$launcherScript`" -RootDir `"$env:INSTALL_ROOT`" -Url $appUrl -TimeoutSeconds $timeoutSeconds -Headless"
          $proc = Start-Process powershell.exe -ArgumentList $launcherArgs -Wait -PassThru

          if ($proc.ExitCode -ne 0) {
            throw "PS1 launcher exited with code $($proc.ExitCode) - open890 did not become ready via launcher path."
          }

      - name: Stop open890
        if: always()
        shell: powershell
        run: |
          $stopScript = "$env:INSTALL_ROOT\bin\open890.bat"
          $traceStopScript = "$env:INSTALL_ROOT\bin\open890-trace.bat"
          $stopStdoutLog = Join-Path $env:RUNNER_TEMP "open890-stop-stdout.log"
          $stopStderrLog = Join-Path $env:RUNNER_TEMP "open890-stop-stderr.log"
          $stopMetaLog = Join-Path $env:RUNNER_TEMP "open890-stop-meta.txt"
          "OPEN890_STOP_STDOUT_LOG=$stopStdoutLog" >> $env:GITHUB_ENV
          "OPEN890_STOP_STDERR_LOG=$stopStderrLog" >> $env:GITHUB_ENV
          "OPEN890_STOP_META_LOG=$stopMetaLog" >> $env:GITHUB_ENV

          if (Test-Path $stopMetaLog) {
            Remove-Item -Path $stopMetaLog -Force -ErrorAction SilentlyContinue
          }

          if (Test-Path $stopScript) {
            $scriptToRun = $stopScript
            if (Test-Path $traceStopScript) {
              $scriptToRun = $traceStopScript
            }
            $env:ELIXIR_CLI_ECHO = "1"
            $stopProc = Start-Process `
              -FilePath $env:ComSpec `
              -ArgumentList @("/d", "/v:on", "/c", "`"$scriptToRun`" stop") `
              -WindowStyle Hidden `
              -PassThru `
              -Wait `
              -RedirectStandardOutput $stopStdoutLog `
              -RedirectStandardError $stopStderrLog

            Add-Content -Path $stopMetaLog -Value ("stop_exit_code={0}" -f $stopProc.ExitCode)
            Add-Content -Path $stopMetaLog -Value ("stop_script={0}" -f $scriptToRun)
            if ($stopProc.ExitCode -ne 0) {
              Add-Content -Path $stopStderrLog -Value ("stop_exit_code={0}" -f $stopProc.ExitCode)
            }
          } else {
            Add-Content -Path $stopMetaLog -Value ("stop_script_missing={0}" -f $stopScript)
          }

      - name: Collect diagnostics
        if: always()
        shell: powershell
        run: |
          $diagDir = Join-Path $env:RUNNER_TEMP "open890-smoke-diagnostics"
          New-Item -Path $diagDir -ItemType Directory -Force | Out-Null
          "DIAG_DIR=$diagDir" >> $env:GITHUB_ENV

          if (Test-Path $env:INSTALL_LOG) {
            Copy-Item -Path $env:INSTALL_LOG -Destination (Join-Path $diagDir "open890-install.log") -Force
          }

          if ($env:OPEN890_START_STDOUT_LOG -and (Test-Path $env:OPEN890_START_STDOUT_LOG)) {
            Copy-Item -Path $env:OPEN890_START_STDOUT_LOG -Destination (Join-Path $diagDir "open890-start-stdout.log") -Force
          }

          if ($env:OPEN890_START_STDERR_LOG -and (Test-Path $env:OPEN890_START_STDERR_LOG)) {
            Copy-Item -Path $env:OPEN890_START_STDERR_LOG -Destination (Join-Path $diagDir "open890-start-stderr.log") -Force
          }

          if ($env:OPEN890_SERVER_LOG -and (Test-Path $env:OPEN890_SERVER_LOG)) {
            Copy-Item -Path $env:OPEN890_SERVER_LOG -Destination (Join-Path $diagDir "open890-server.log") -Force
          }

          if ($env:OPEN890_PROBE_LOG -and (Test-Path $env:OPEN890_PROBE_LOG)) {
            Copy-Item -Path $env:OPEN890_PROBE_LOG -Destination (Join-Path $diagDir "open890-readiness-probe.log") -Force
          }

          if ($env:OPEN890_START_META_LOG -and (Test-Path $env:OPEN890_START_META_LOG)) {
            Copy-Item -Path $env:OPEN890_START_META_LOG -Destination (Join-Path $diagDir "open890-start-meta.txt") -Force
          }

          if ($env:OPEN890_STOP_STDOUT_LOG -and (Test-Path $env:OPEN890_STOP_STDOUT_LOG)) {
            Copy-Item -Path $env:OPEN890_STOP_STDOUT_LOG -Destination (Join-Path $diagDir "open890-stop-stdout.log") -Force
          }

          if ($env:OPEN890_STOP_STDERR_LOG -and (Test-Path $env:OPEN890_STOP_STDERR_LOG)) {
            Copy-Item -Path $env:OPEN890_STOP_STDERR_LOG -Destination (Join-Path $diagDir "open890-stop-stderr.log") -Force
          }

          if ($env:OPEN890_STOP_META_LOG -and (Test-Path $env:OPEN890_STOP_META_LOG)) {
            Copy-Item -Path $env:OPEN890_STOP_META_LOG -Destination (Join-Path $diagDir "open890-stop-meta.txt") -Force
          }

          if ($env:LAUNCHER_STDOUT_LOG -and (Test-Path $env:LAUNCHER_STDOUT_LOG)) {
            Copy-Item -Path $env:LAUNCHER_STDOUT_LOG -Destination (Join-Path $diagDir "open890-launcher-stdout.log") -Force
          }

          if ($env:LAUNCHER_STDERR_LOG -and (Test-Path $env:LAUNCHER_STDERR_LOG)) {
            Copy-Item -Path $env:LAUNCHER_STDERR_LOG -Destination (Join-Path $diagDir "open890-launcher-stderr.log") -Force
          }

          if (Test-Path $env:INSTALL_ROOT) {
            $scriptFiles = @{
              "installed-open890-launcher.bat" = (Join-Path $env:INSTALL_ROOT "open890-launcher.bat")
              "installed-open890-launcher.ps1" = (Join-Path $env:INSTALL_ROOT "open890-launcher.ps1")
              "installed-bin-open890.bat" = (Join-Path $env:INSTALL_ROOT "bin\open890.bat")
              "installed-bin-open890-trace.bat" = (Join-Path $env:INSTALL_ROOT "bin\open890-trace.bat")
            }

            foreach ($destName in $scriptFiles.Keys) {
              $sourcePath = $scriptFiles[$destName]
              if (Test-Path $sourcePath) {
                Copy-Item -Path $sourcePath -Destination (Join-Path $diagDir $destName) -Force
              }
            }
          }

          $launcherDirListing = Join-Path $diagDir "install-dir-listing.txt"
          if (Test-Path $env:INSTALL_ROOT) {
            Get-ChildItem -Path $env:INSTALL_ROOT -Recurse -Depth 2 -Force |
              Select-Object FullName, Length, LastWriteTime |
              Format-Table -AutoSize |
              Out-File -FilePath $launcherDirListing -Encoding UTF8
          }

          $eventLogPath = Join-Path $diagDir "windows-application-events.txt"
          Get-WinEvent -LogName Application -MaxEvents 600 -ErrorAction SilentlyContinue |
            Where-Object { $_.Message -match 'open890|beam|erlang|vcruntime|ucrtbase' } |
            Select-Object TimeCreated, ProviderName, Id, LevelDisplayName, Message |
            Format-List |
            Out-File -FilePath $eventLogPath -Encoding UTF8

          $processLogPath = Join-Path $diagDir "windows-process-snapshot.txt"
          Get-Process -ErrorAction SilentlyContinue |
            Where-Object { $_.ProcessName -match 'open890|beam|erl|epmd' } |
            Select-Object Name, Id, StartTime, CPU, Path |
            Format-Table -AutoSize |
            Out-File -FilePath $processLogPath -Encoding UTF8

          $summary = Join-Path $diagDir "summary.txt"
          @(
            "installer_url=${{ inputs.installer_url }}",
            "app_url=${{ inputs.app_url }}",
            "timeout_seconds=${{ inputs.timeout_seconds }}",
            "install_root=$env:INSTALL_ROOT",
            "install_exit_code=$env:INSTALL_EXIT_CODE"
          ) | Out-File -FilePath $summary -Encoding UTF8

      - name: Upload diagnostics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-smoke-diagnostics
          path: ${{ env.DIAG_DIR }}
          if-no-files-found: error
