name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  OTP_VERSION: '24.3.4'
  ELIXIR_VERSION: '1.14.2'
  NODE_VERSION: '18.12.1'

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set vars
        id: vars
        run: |
          echo "TAG=${GITHUB_REF#refs/*/}" >> "$GITHUB_OUTPUT"
          cat "$GITHUB_OUTPUT"

      - name: Install OTP and Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          elixir-version: ${{ env.ELIXIR_VERSION }}

      - name: Install NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          mix local.rebar --force
          mix local.hex --force
          mix deps.get --only prod

      - name: Compile Web Assets
        run: |
          yarn install --cwd assets
          mix assets.deploy
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Build release
        run: |
          mix release
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Include first-time setup guide in bundle
        run: |
          cp docs/FIRST_TIME_SETUP.md _build/prod/rel/open890/FIRST_TIME_SETUP.md

      - name: Compress release
        uses: master-atul/tar-action@v1.1.2
        with:
          command: c
          cwd: ./_build/prod/rel
          files: |
            ./open890
          outPath: /tmp/open890-${{ steps.vars.outputs.TAG }}-ubuntu-x64.tar.gz

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-ubuntu
          path: /tmp/open890-${{ steps.vars.outputs.TAG }}-ubuntu-x64.tar.gz
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set vars
        id: vars
        shell: bash
        run: |
          echo "TAG=${GITHUB_REF#refs/*/}" >> "$GITHUB_OUTPUT"
          cat "$GITHUB_OUTPUT"

      - name: Install Erlang and Elixir
        env:
          ERLANG_VERSION: ${{ env.OTP_VERSION }}
          ELIXIR_VERSION: ${{ env.ELIXIR_VERSION }}
        run: |
          build_scripts\win64\install_elixir.ps1
          echo "c:\erlang\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "c:\elixir\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          mix local.rebar --force
          mix local.hex --force
          mix deps.get --only prod

      - name: Compile Web Assets
        run: |
          yarn install --cwd assets
          mix assets.deploy.windows
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Build release
        run: |
          mix release
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Include first-time setup guide in bundle
        run: |
          Copy-Item -Path docs/FIRST_TIME_SETUP.md -Destination _build\prod\rel\open890\FIRST_TIME_SETUP.md -Force

      - name: Compress release
        run: |
          cd _build\prod\rel
          7z a ..\..\..\open890-${{ steps.vars.outputs.TAG }}-windows-x64.zip open890\
          cd ..\..\..

      - name: Install Inno Setup
        run: |
          choco install innosetup --no-progress -y

      - name: Build Windows installer
        shell: powershell
        run: |
          $tag = "${{ steps.vars.outputs.TAG }}"
          $version = $tag -replace '^v',''
          $sourceDir = (Resolve-Path "_build\prod\rel\open890").Path
          $outputDir = (Get-Location).Path
          $baseName = "open890-$tag-setup"
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          & $iscc "/DMyAppVersion=$version" "/DSourceDir=$sourceDir" "/DOutputDir=$outputDir" "/F$baseName" "installers\windows\open890.iss"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: open890-${{ steps.vars.outputs.TAG }}-windows-x64.zip
          if-no-files-found: error

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows-installer
          path: open890-${{ steps.vars.outputs.TAG }}-setup.exe
          if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set vars
        id: vars
        run: |
          echo "TAG=${GITHUB_REF#refs/*/}" >> "$GITHUB_OUTPUT"
          cat "$GITHUB_OUTPUT"

      - name: Install OTP and Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          elixir-version: ${{ env.ELIXIR_VERSION }}

      - name: Install NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          mix local.rebar --force
          mix local.hex --force
          mix deps.get --only prod

      - name: Compile Web Assets
        run: |
          yarn install --cwd assets
          mix assets.deploy
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Build release
        run: |
          mix release
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Include first-time setup guide in bundle
        run: |
          cp docs/FIRST_TIME_SETUP.md _build/prod/rel/open890/FIRST_TIME_SETUP.md

      - name: Compress release
        uses: master-atul/tar-action@v1.1.2
        with:
          command: c
          cwd: ./_build/prod/rel
          files: |
            ./open890
          outPath: /tmp/open890-${{ steps.vars.outputs.TAG }}-macos.tar.gz

      - name: Build unsigned macOS pkg installer
        run: |
          TAG="${{ steps.vars.outputs.TAG }}"
          VERSION="${TAG#v}"
          PKGROOT="$RUNNER_TEMP/pkgroot"
          mkdir -p "$PKGROOT/Applications/open890"
          cp -R _build/prod/rel/open890/. "$PKGROOT/Applications/open890/"
          pkgbuild \
            --root "$PKGROOT" \
            --identifier "org.open890.pkg" \
            --version "$VERSION" \
            --install-location "/" \
            "/tmp/open890-${TAG}-macos-installer.pkg"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: /tmp/open890-${{ steps.vars.outputs.TAG }}-macos.tar.gz
          if-no-files-found: error

      - name: Upload macOS pkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos-pkg
          path: /tmp/open890-${{ steps.vars.outputs.TAG }}-macos-installer.pkg
          if-no-files-found: error

  publish-release:
    needs: [build-ubuntu, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Ubuntu artifact
        uses: actions/download-artifact@v4
        with:
          name: release-ubuntu
          path: dist

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: release-windows
          path: dist

      - name: Download Windows installer artifact
        uses: actions/download-artifact@v4
        with:
          name: release-windows-installer
          path: dist

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: release-macos
          path: dist

      - name: Download macOS pkg artifact
        uses: actions/download-artifact@v4
        with:
          name: release-macos-pkg
          path: dist

      - name: Copy release documentation
        run: |
          cp docs/FIRST_TIME_SETUP.md dist/open890-FIRST_TIME_SETUP.md

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/open890-*.tar.gz
            dist/open890-*.zip
            dist/open890-*.exe
            dist/open890-*.pkg
            dist/open890-FIRST_TIME_SETUP.md
          generate_release_notes: true
