name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  OTP_VERSION: '24.3.4'
  ELIXIR_VERSION: '1.14.2'
  NODE_VERSION: '18.12.1'

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set vars
        id: vars
        run: |
          echo "TAG=${GITHUB_REF#refs/*/}" >> "$GITHUB_OUTPUT"
          cat "$GITHUB_OUTPUT"

      - name: Install OTP and Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          elixir-version: ${{ env.ELIXIR_VERSION }}

      - name: Install NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          mix local.rebar --force
          mix local.hex --force
          mix deps.get --only prod

      - name: Compile Web Assets
        run: |
          yarn install --cwd assets
          mix assets.deploy
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Build release
        run: |
          mix release
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Include first-time setup guide in bundle
        run: |
          cp docs/FIRST_TIME_SETUP.md _build/prod/rel/open890/FIRST_TIME_SETUP.md

      - name: Keep Linux launcher files only
        run: |
          RELEASE_DIR="_build/prod/rel/open890"
          rm -f \
            "$RELEASE_DIR/open890.command" \
            "$RELEASE_DIR/open890-stop.command" \
            "$RELEASE_DIR/open890-launcher-macos.sh" \
            "$RELEASE_DIR/open890.bat" \
            "$RELEASE_DIR/open890-launcher.bat" \
            "$RELEASE_DIR/open890-launcher.ps1"

          test -f "$RELEASE_DIR/open890.sh"
          test ! -e "$RELEASE_DIR/open890.command"
          test ! -e "$RELEASE_DIR/open890-stop.command"
          test ! -e "$RELEASE_DIR/open890-launcher-macos.sh"
          test ! -e "$RELEASE_DIR/open890.bat"
          test ! -e "$RELEASE_DIR/open890-launcher.bat"
          test ! -e "$RELEASE_DIR/open890-launcher.ps1"

      - name: Compress release
        uses: master-atul/tar-action@v1.1.2
        with:
          command: c
          cwd: ./_build/prod/rel
          files: |
            ./open890
          outPath: /tmp/open890-${{ steps.vars.outputs.TAG }}-ubuntu-x64.tar.gz

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-ubuntu
          path: /tmp/open890-${{ steps.vars.outputs.TAG }}-ubuntu-x64.tar.gz
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set vars
        id: vars
        shell: bash
        run: |
          echo "TAG=${GITHUB_REF#refs/*/}" >> "$GITHUB_OUTPUT"
          cat "$GITHUB_OUTPUT"

      - name: Install Erlang and Elixir
        env:
          ERLANG_VERSION: ${{ env.OTP_VERSION }}
          ELIXIR_VERSION: ${{ env.ELIXIR_VERSION }}
        run: |
          build_scripts\win64\install_elixir.ps1
          echo "c:\erlang\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "c:\elixir\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          mix local.rebar --force
          mix local.hex --force
          mix deps.get --only prod

      - name: Compile Web Assets
        run: |
          yarn install --cwd assets
          mix assets.deploy.windows
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Build release
        run: |
          mix release
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Include first-time setup guide in bundle
        run: |
          Copy-Item -Path docs/FIRST_TIME_SETUP.md -Destination _build\prod\rel\open890\FIRST_TIME_SETUP.md -Force

      - name: Keep Windows launcher files only
        shell: powershell
        run: |
          $releaseDir = "_build\prod\rel\open890"
          $releaseBinScript = "$releaseDir\bin\open890.bat"
          Remove-Item -Path @(
            "$releaseDir\open890.command",
            "$releaseDir\open890-stop.command",
            "$releaseDir\open890-launcher-macos.sh",
            "$releaseDir\open890.sh"
          ) -Force -ErrorAction SilentlyContinue

          if (!(Test-Path $releaseBinScript)) { throw "Missing release launcher script: $releaseBinScript" }

          $lines = Get-Content -Path $releaseBinScript
          $patched = $false
          for ($i = 0; $i -lt $lines.Count; $i++) {
            $line = $lines[$i].Trim().ToLower()
            if ($line -eq 'cd "%~dp0\.."') {
              $lines[$i] = 'cd /d "%~dp0\.."'
              $patched = $true
              break
            }
            if ($line -eq 'cd /d "%~dp0\.."') {
              $patched = $true
              break
            }
          }
          if (-not $patched) {
            throw "Unable to patch open890.bat drive switch line."
          }
          Set-Content -Path $releaseBinScript -Value $lines -Encoding ascii

          if (-not (Select-String -Path $releaseBinScript -Pattern 'cd /d "%~dp0\.."' -SimpleMatch)) {
            throw "Patch verification failed for $releaseBinScript"
          }

          if (!(Test-Path "$releaseDir\open890.bat")) { throw "Missing open890.bat" }
          if (!(Test-Path "$releaseDir\open890-launcher.bat")) { throw "Missing open890-launcher.bat" }
          if (!(Test-Path "$releaseDir\open890-launcher.ps1")) { throw "Missing open890-launcher.ps1" }
          if (Test-Path "$releaseDir\open890.command") { throw "Unexpected macOS launcher file present" }
          if (Test-Path "$releaseDir\open890-stop.command") { throw "Unexpected macOS stop file present" }
          if (Test-Path "$releaseDir\open890-launcher-macos.sh") { throw "Unexpected macOS launcher script present" }
          if (Test-Path "$releaseDir\open890.sh") { throw "Unexpected Linux launcher file present" }

      - name: Compress release
        run: |
          cd _build\prod\rel
          7z a ..\..\..\open890-${{ steps.vars.outputs.TAG }}-windows-x64.zip open890\
          cd ..\..\..

      - name: Install Inno Setup
        run: |
          choco install innosetup --no-progress -y

      - name: Build Windows installer
        shell: powershell
        run: |
          $tag = "${{ steps.vars.outputs.TAG }}"
          $version = $tag -replace '^v',''
          $sourceDir = (Resolve-Path "_build\prod\rel\open890").Path
          $outputDir = (Get-Location).Path
          $baseName = "open890-$tag-setup"
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          & $iscc "/DMyAppVersion=$version" "/DSourceDir=$sourceDir" "/DOutputDir=$outputDir" "/F$baseName" "installers\windows\open890.iss"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: open890-${{ steps.vars.outputs.TAG }}-windows-x64.zip
          if-no-files-found: error

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows-installer
          path: open890-${{ steps.vars.outputs.TAG }}-setup.exe
          if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set vars
        id: vars
        run: |
          echo "TAG=${GITHUB_REF#refs/*/}" >> "$GITHUB_OUTPUT"
          cat "$GITHUB_OUTPUT"

      - name: Install OTP and Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: '25'
          elixir-version: ${{ env.ELIXIR_VERSION }}

      - name: Install NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          mix local.rebar --force
          mix local.hex --force
          mix deps.get --only prod

      - name: Compile Web Assets
        run: |
          yarn install --cwd assets
          mix assets.deploy
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Build release
        run: |
          mix release
        env:
          MIX_ENV: prod
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}

      - name: Include first-time setup guide in bundle
        run: |
          cp docs/FIRST_TIME_SETUP.md _build/prod/rel/open890/FIRST_TIME_SETUP.md

      - name: Keep macOS launcher files only
        run: |
          RELEASE_DIR="_build/prod/rel/open890"
          rm -f \
            "$RELEASE_DIR/open890.bat" \
            "$RELEASE_DIR/open890-launcher.bat" \
            "$RELEASE_DIR/open890-launcher.ps1" \
            "$RELEASE_DIR/open890.sh"

          test -f "$RELEASE_DIR/open890.command"
          test -f "$RELEASE_DIR/open890-stop.command"
          test -f "$RELEASE_DIR/open890-launcher-macos.sh"
          test ! -e "$RELEASE_DIR/open890.bat"
          test ! -e "$RELEASE_DIR/open890-launcher.bat"
          test ! -e "$RELEASE_DIR/open890-launcher.ps1"
          test ! -e "$RELEASE_DIR/open890.sh"

      - name: Compress release
        uses: master-atul/tar-action@v1.1.2
        with:
          command: c
          cwd: ./_build/prod/rel
          files: |
            ./open890
          outPath: /tmp/open890-${{ steps.vars.outputs.TAG }}-macos.tar.gz

      - name: Build unsigned macOS pkg installer
        run: |
          TAG="${{ steps.vars.outputs.TAG }}"
          VERSION="${TAG#v}"
          PKGROOT="$RUNNER_TEMP/pkgroot"
          mkdir -p "$PKGROOT/Applications/open890"
          cp -R _build/prod/rel/open890/. "$PKGROOT/Applications/open890/"

          # Normalize and validate executable permissions for launch scripts.
          REQUIRED_EXECUTABLES=(
            "$PKGROOT/Applications/open890/open890.command"
            "$PKGROOT/Applications/open890/open890-stop.command"
            "$PKGROOT/Applications/open890/open890-launcher-macos.sh"
            "$PKGROOT/Applications/open890/bin/open890"
          )

          for target in "${REQUIRED_EXECUTABLES[@]}"; do
            if [[ ! -e "$target" ]]; then
              echo "Missing expected executable: $target" >&2
              exit 1
            fi
            chmod 755 "$target"
            if [[ ! -x "$target" ]]; then
              echo "Failed to mark executable: $target" >&2
              exit 1
            fi
          done

          pkgbuild \
            --root "$PKGROOT" \
            --identifier "org.open890.pkg" \
            --version "$VERSION" \
            --install-location "/" \
            "/tmp/open890-${TAG}-macos-installer.pkg"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: /tmp/open890-${{ steps.vars.outputs.TAG }}-macos.tar.gz
          if-no-files-found: error

      - name: Upload macOS pkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos-pkg
          path: /tmp/open890-${{ steps.vars.outputs.TAG }}-macos-installer.pkg
          if-no-files-found: error

  smoke-windows:
    needs: [build-windows]
    runs-on: windows-latest
    steps:
      - name: Download Windows installer artifact
        uses: actions/download-artifact@v4
        with:
          name: release-windows-installer
          path: ${{ runner.temp }}\installer

      - name: Run installer silently
        shell: powershell
        run: |
          $installerPath = Get-ChildItem -Path "$env:RUNNER_TEMP\installer" -Filter "*.exe" | Select-Object -First 1 -ExpandProperty FullName
          if (-not $installerPath) { throw "Installer .exe not found in artifact." }
          $installLog = Join-Path $env:RUNNER_TEMP "open890-install.log"
          $proc = Start-Process -FilePath $installerPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP- /LOG=`"$installLog`"" -Wait -PassThru
          "INSTALL_LOG=$installLog" >> $env:GITHUB_ENV
          if ($proc.ExitCode -ne 0) { throw "Installer exited with code $($proc.ExitCode)" }

      - name: Locate install directory
        shell: powershell
        run: |
          $candidates = @("$env:ProgramFiles\open890", "${env:ProgramFiles(x86)}\open890")
          $installRoot = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $installRoot) { throw "open890 install directory not found under Program Files." }
          "INSTALL_ROOT=$installRoot" >> $env:GITHUB_ENV

      - name: Verify installed files and cd /d patch
        shell: powershell
        run: |
          $required = @(
            "$env:INSTALL_ROOT\open890-launcher.bat",
            "$env:INSTALL_ROOT\open890-launcher.ps1",
            "$env:INSTALL_ROOT\bin\open890.bat"
          )
          foreach ($path in $required) {
            if (!(Test-Path $path)) { throw "Missing required file: $path" }
          }
          $binScript = "$env:INSTALL_ROOT\bin\open890.bat"
          if ((Get-Content $binScript -Raw) -notlike '*cd /d "%~dp0\.."*') {
            throw "bin\open890.bat is missing the drive switch fix (cd /d)."
          }

      - name: Start open890 via PS1 launcher (headless)
        shell: powershell
        run: |
          $appUrl = "http://localhost:4000"
          $serverLog = Join-Path $env:RUNNER_TEMP "open890-server.log"
          "OPEN890_SERVER_LOG=$serverLog" >> $env:GITHUB_ENV
          $proc = Start-Process powershell `
            -ArgumentList @(
              "-NoProfile", "-ExecutionPolicy", "Bypass", "-File",
              "`"$env:INSTALL_ROOT\open890-launcher.ps1`"",
              "-RootDir", "`"$env:INSTALL_ROOT`"",
              "-Url", $appUrl,
              "-TimeoutSeconds", "90",
              "-Headless"
            ) `
            -Wait -PassThru `
            -RedirectStandardOutput (Join-Path $env:RUNNER_TEMP "launcher-stdout.log") `
            -RedirectStandardError  (Join-Path $env:RUNNER_TEMP "launcher-stderr.log")
          "LAUNCHER_EXIT_CODE=$($proc.ExitCode)" >> $env:GITHUB_ENV
          if ($proc.ExitCode -ne 0) {
            Get-Content (Join-Path $env:RUNNER_TEMP "launcher-stderr.log") -ErrorAction SilentlyContinue
            throw "Launcher exited with code $($proc.ExitCode) - open890 did not become ready."
          }

      - name: Stop open890
        if: always()
        shell: powershell
        run: |
          if (Test-Path "$env:INSTALL_ROOT\bin\open890.bat") {
            Start-Process -FilePath $env:ComSpec -ArgumentList "/c `"$env:INSTALL_ROOT\bin\open890.bat`" stop" -Wait -WindowStyle Hidden
          }

      - name: Upload smoke diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-windows-diagnostics
          path: |
            ${{ env.INSTALL_LOG }}
            ${{ env.OPEN890_SERVER_LOG }}
            ${{ runner.temp }}/launcher-stdout.log
            ${{ runner.temp }}/launcher-stderr.log
          if-no-files-found: ignore

  smoke-ubuntu:
    needs: [build-ubuntu]
    runs-on: ubuntu-latest
    steps:
      - name: Download Ubuntu artifact
        uses: actions/download-artifact@v4
        with:
          name: release-ubuntu
          path: ${{ runner.temp }}/release

      - name: Extract release
        run: |
          TARBALL=$(find "$RUNNER_TEMP/release" -name "*.tar.gz" | head -1)
          if [ -z "$TARBALL" ]; then echo "Tarball not found in artifact."; exit 1; fi
          tar -xzf "$TARBALL" -C "$RUNNER_TEMP/release"
          RELEASE_ROOT=$(find "$RUNNER_TEMP/release" -maxdepth 1 -type d -name "open890" | head -1)
          if [ -z "$RELEASE_ROOT" ]; then echo "open890 directory not found after extraction."; exit 1; fi
          echo "RELEASE_ROOT=$RELEASE_ROOT" >> "$GITHUB_ENV"

      - name: Verify installed files
        run: |
          for f in "$RELEASE_ROOT/open890.sh" "$RELEASE_ROOT/bin/open890"; do
            if [ ! -f "$f" ]; then echo "Missing required file: $f"; exit 1; fi
          done
          for f in \
            "$RELEASE_ROOT/open890.command" \
            "$RELEASE_ROOT/open890-stop.command" \
            "$RELEASE_ROOT/open890-launcher-macos.sh" \
            "$RELEASE_ROOT/open890-launcher.bat" \
            "$RELEASE_ROOT/open890-launcher.ps1"; do
            if [ -f "$f" ]; then echo "Unexpected non-Linux file present: $f"; exit 1; fi
          done

      - name: Start open890 and wait for readiness
        run: |
          SERVER_LOG="$RUNNER_TEMP/open890-server.log"
          echo "OPEN890_SERVER_LOG=$SERVER_LOG" >> "$GITHUB_ENV"
          cd "$RELEASE_ROOT"
          nohup ./bin/open890 start > "$SERVER_LOG" 2>&1 &
          READY=0
          for i in $(seq 1 90); do
            if curl -fsSI "http://localhost:4000" >/dev/null 2>&1; then
              READY=1
              break
            fi
            sleep 1
          done
          if [ "$READY" -ne 1 ]; then
            echo "=== server log ==="
            cat "$SERVER_LOG" 2>/dev/null || echo "(no log)"
            echo "open890 did not become ready within 90 seconds."
            exit 1
          fi

      - name: Stop open890
        if: always()
        run: |
          cd "$RELEASE_ROOT" && ./bin/open890 stop 2>/dev/null || true

      - name: Upload smoke diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-ubuntu-diagnostics
          path: ${{ env.OPEN890_SERVER_LOG }}
          if-no-files-found: ignore

  smoke-macos:
    needs: [build-macos]
    runs-on: macos-latest
    steps:
      - name: Download macOS pkg artifact
        uses: actions/download-artifact@v4
        with:
          name: release-macos-pkg
          path: ${{ runner.temp }}/pkg

      - name: Install macOS pkg
        run: |
          PKG_PATH=$(find "$RUNNER_TEMP/pkg" -name "*.pkg" | head -1)
          if [ -z "$PKG_PATH" ]; then echo "pkg not found in artifact."; exit 1; fi
          xattr -rd com.apple.quarantine "$PKG_PATH" 2>/dev/null || true
          sudo installer -pkg "$PKG_PATH" -target /
          echo "INSTALL_ROOT=/Applications/open890" >> "$GITHUB_ENV"

      - name: Verify installed files and executable bits
        run: |
          for f in \
            "$INSTALL_ROOT/open890.command" \
            "$INSTALL_ROOT/open890-stop.command" \
            "$INSTALL_ROOT/open890-launcher-macos.sh" \
            "$INSTALL_ROOT/bin/open890"; do
            if [ ! -f "$f" ]; then echo "Missing required file: $f"; exit 1; fi
            if [ ! -x "$f" ]; then echo "Not executable: $f"; exit 1; fi
          done
          for f in \
            "$INSTALL_ROOT/open890-launcher.bat" \
            "$INSTALL_ROOT/open890-launcher.ps1" \
            "$INSTALL_ROOT/open890.sh"; do
            if [ -f "$f" ]; then echo "Unexpected non-macOS file present: $f"; exit 1; fi
          done

      - name: Start open890 via macOS launcher
        run: |
          SERVER_LOG="$RUNNER_TEMP/open890-server.log"
          echo "OPEN890_SERVER_LOG=$SERVER_LOG" >> "$GITHUB_ENV"
          OPEN890_LOG_FILE="$SERVER_LOG" OPEN890_START_TIMEOUT_SECONDS=90 \
            "$INSTALL_ROOT/open890-launcher-macos.sh"
          if ! /usr/bin/curl -fsSI "http://localhost:4000" >/dev/null 2>&1; then
            echo "=== server log ==="
            cat "$SERVER_LOG" 2>/dev/null || echo "(no log)"
            echo "open890 not ready after launcher exit."
            exit 1
          fi

      - name: Stop open890
        if: always()
        run: |
          "$INSTALL_ROOT/bin/open890" stop 2>/dev/null || true

      - name: Upload smoke diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-macos-diagnostics
          path: ${{ env.OPEN890_SERVER_LOG }}
          if-no-files-found: ignore

  publish-release:
    needs: [smoke-ubuntu, smoke-windows, smoke-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Ubuntu artifact
        uses: actions/download-artifact@v4
        with:
          name: release-ubuntu
          path: dist

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: release-windows
          path: dist

      - name: Download Windows installer artifact
        uses: actions/download-artifact@v4
        with:
          name: release-windows-installer
          path: dist

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: release-macos
          path: dist

      - name: Download macOS pkg artifact
        uses: actions/download-artifact@v4
        with:
          name: release-macos-pkg
          path: dist

      - name: Copy release documentation
        run: |
          cp docs/FIRST_TIME_SETUP.md dist/open890-FIRST_TIME_SETUP.md

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/open890-*.tar.gz
            dist/open890-*.zip
            dist/open890-*.exe
            dist/open890-*.pkg
            dist/open890-FIRST_TIME_SETUP.md
          generate_release_notes: true
